# --------------------------------------------------------------------
# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# --------------------------------------------------------------------

# Integration test Docker Compose configuration
# Uses coverage-enabled image (build with: make build-coverage-image)

services:
  gateway-controller:
    container_name: it-gateway-controller
    image: ghcr.io/wso2/api-platform/gateway-controller-coverage:0.1.0-SNAPSHOT
    mem_limit: 128m
    mem_reservation: 128m
    cpus: 0.1
    ports:
      - "9090:9090"   # REST API
      - "18000:18000" # xDS gRPC
      - "18001:18001"
    environment:
      - GATEWAY_STORAGE_TYPE=sqlite
      - GATEWAY_STORAGE_SQLITE_PATH=./data/gateway.db
      - GATEWAY_LOGGING_LEVEL=info
      - GOCOVERDIR=/coverage
    volumes:
      - controller-data-tests:/app/data
      - ../configs/config.yaml:/app/config/config.yaml:ro
      - ../gateway-controller/certificates:/app/certificates
      - ../gateway-controller/listener-certs:/app/listener-certs:ro
      - ./coverage/gateway-controller:/coverage
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "http://localhost:9090/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - it-gateway-network

  policy-engine:
    container_name: it-policy-engine
    image: ghcr.io/wso2/api-platform/policy-engine:0.1.0-SNAPSHOT
    mem_limit: 128m
    mem_reservation: 128m
    cpus: 0.2
    command: ["-xds-server", "it-gateway-controller:18001"]
    ports:
      - "9002:9002"   # Admin API
    volumes:
      - ../configs/config.yaml:/app/configs/config.yaml:ro
    depends_on:
      gateway-controller:
        condition: service_healthy
    networks:
      - it-gateway-network

  router:
    container_name: it-router
    image: ghcr.io/wso2/api-platform/gateway-router:0.1.0-SNAPSHOT
    mem_limit: 256m
    mem_reservation: 256m
    cpus: 0.2
    ports:
      - "8080:8080"   # HTTP traffic
      - "8443:8443"   # HTTPS traffic
      - "9901:9901"   # Envoy admin
    environment:
      - XDS_SERVER_HOST=it-gateway-controller
      - XDS_SERVER_PORT=18000
    depends_on:
      gateway-controller:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/9901"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s
    networks:
      - it-gateway-network

  sample-backend:
    container_name: it-sample-backend
    image: renukafernando/request-info:latest
    ports:
      - "5000:5000"
    command: ["-addr", ":5000", "-pretty"]
    networks:
      - it-gateway-network

  mcp-server-backend:
    image: rakhitharr/mcp-everything:v3
    pull_policy: missing
    container_name: mcp-server-backend
    ports:
      - "3001:3001"
    networks:
      - it-gateway-network

volumes:
  controller-data-tests:
    driver: local

networks:
  it-gateway-network:
    driver: bridge
