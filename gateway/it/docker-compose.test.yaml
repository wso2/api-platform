# --------------------------------------------------------------------
# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# --------------------------------------------------------------------

# Integration test Docker Compose configuration
# Uses coverage-enabled image (build with: make build-coverage-image)

services:
  gateway-controller:
    container_name: it-gateway-controller
    image: ghcr.io/wso2/api-platform/gateway-controller-coverage:0.5.0-SNAPSHOT
    mem_limit: 128m
    mem_reservation: 128m
    cpus: 0.1
    command: ["-config", "/etc/gateway-controller/config.toml"]
    ports:
      - "9010:9090"   # REST API
      - "18000:18000" # xDS gRPC
      - "18001:18001"
      - "9091:9091"   # Metrics
    environment:
      - APIP_GW_GATEWAY__CONTROLLER_STORAGE_TYPE=sqlite
      - APIP_GW_GATEWAY__CONTROLLER_STORAGE_SQLITE_PATH=./data/gateway.db
      - APIP_GW_GATEWAY__CONTROLLER_LOGGING_LEVEL=debug
      - GOCOVERDIR=/coverage
    volumes:
      - controller-data-tests:/app/data
      - ./test-config.toml:/etc/gateway-controller/config.toml:ro
      - ../gateway-controller/certificates:/app/certificates
      - ../gateway-controller/listener-certs:/app/listener-certs:ro
      - ./coverage/gateway-controller:/coverage
    networks:
      - it-gateway-network

  policy-engine:
    container_name: it-policy-engine
    image: ghcr.io/wso2/api-platform/policy-engine:0.5.0-SNAPSHOT
    mem_limit: 128m
    mem_reservation: 128m
    cpus: 0.2
    command: ["-config", "/etc/policy-engine/config.toml", "-xds-server", "it-gateway-controller:18001"]
    ports:
      - "9002:9002"   # Admin API
      - "9003:9003"   # Metrics
    volumes:
      - ./test-config.toml:/etc/policy-engine/config.toml:ro
    depends_on:
      gateway-controller:
        condition: service_healthy
    networks:
      - it-gateway-network

  router:
    container_name: it-router
    image: ghcr.io/wso2/api-platform/gateway-router:0.5.0-SNAPSHOT
    mem_limit: 256m
    mem_reservation: 256m
    cpus: 0.2
    ports:
      - "8080:8080"   # HTTP traffic
      - "8443:8443"   # HTTPS traffic
      - "9901:9901"   # Envoy admin
    environment:
      - XDS_SERVER_HOST=it-gateway-controller
      - XDS_SERVER_PORT=18000
      - LOG_LEVEL=info
    networks:
      - it-gateway-network

  sample-backend:
    container_name: it-sample-backend
    image: renukafernando/request-info:latest
    ports:
      - "9080:9080"
    command: ["-addr", ":9080", "-pretty"]
    networks:
      - it-gateway-network

  mcp-server-backend:
    image: rakhitharr/mcp-everything:v3
    pull_policy: missing
    container_name: mcp-server-backend
    ports:
      - "3001:3001"
    networks:
      - it-gateway-network

  # Echo backend for testing cost extraction - returns request body in response JSON
  echo-backend:
    container_name: it-echo-backend
    image: kennethreitz/httpbin:latest
    ports:
      - "9081:80"
    networks:
      - it-gateway-network

  # Mock JWKS server for JWT authentication testing
  mock-jwks:
    container_name: it-mock-jwks
    image: ghcr.io/wso2/api-platform/mock-jwks:latest
    build:
      context: ../../tests/mock-servers/mock-jwks
      dockerfile: Dockerfile
    ports:
      - "8082:8080"
    networks:
      - it-gateway-network

volumes:
  controller-data-tests:
    driver: local

networks:
  it-gateway-network:
    driver: bridge
