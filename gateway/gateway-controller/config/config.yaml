# Gateway-Controller Configuration
# This file contains configuration for the WSO2 API Platform Gateway Controller

# Server configuration
server:
  # REST API port for gateway management
  api_port: 9090

  # xDS gRPC port for Envoy communication
  xds_port: 18000

  # Graceful shutdown timeout
  shutdown_timeout: 15s

# Policy xDS Server configuration
policyserver:
  # Enable or disable the policy xDS server
  enabled: true

  # Policy xDS gRPC port for policy distribution
  port: 18001

  # TLS configuration for secure policy xDS communication
  tls:
    # Enable or disable TLS
    enabled: false

    # Path to TLS certificate file (required if TLS is enabled)
    cert_file: "./certs/server.crt"

    # Path to TLS private key file (required if TLS is enabled)
    key_file: "./certs/server.key"

# Storage configuration
storage:
  # Storage type: "sqlite", "postgres" (future), or "memory"
  # - sqlite: Use SQLite embedded database for persistence
  # - postgres: Use PostgreSQL database for persistence (future support)
  # - memory: No persistent storage, all configs lost on restart (useful for testing)
  type: sqlite

  # SQLite configuration (used when type=sqlite)
  sqlite:
    path: ./data/gateway.db

# Policy configuration
policies:
  # Directory containing policy definitions
  definitions_path: ./default-policies

# Router (Envoy) configuration
router:
  # Gateway host for incoming requests
  gateway_host: "*"
  
  # Access logs configuration
  access_logs:
    # Enable or disable access logs
    enabled: true

    # Log format: "json" or "text"
    # - json: Structured JSON format (recommended for log aggregation)
    # - text: Human-readable text format
    format: json

    # JSON format fields - key-value pairs for structured logging
    # Uses Envoy command operators: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage
    json_fields:
      start_time: "%START_TIME%"
      method: "%REQ(:METHOD)%"
      path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
      protocol: "%PROTOCOL%"
      response_code: "%RESPONSE_CODE%"
      response_flags: "%RESPONSE_FLAGS%"
      response_flags_long: "%RESPONSE_FLAGS_LONG%"
      bytes_received: "%BYTES_RECEIVED%"
      bytes_sent: "%BYTES_SENT%"
      duration: "%DURATION%"
      upstream_service_time: "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
      x_forwarded_for: "%REQ(X-FORWARDED-FOR)%"
      user_agent: "%REQ(USER-AGENT)%"
      request_id: "%REQ(X-REQUEST-ID)%"
      authority: "%REQ(:AUTHORITY)%"
      upstream_host: "%UPSTREAM_HOST%"
      upstream_cluster: "%UPSTREAM_CLUSTER%"

    # Text format template - used when format is "text"
    # Uses Envoy command operators: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage
    text_format: |
      [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"

  # Listener port for incoming HTTP traffic (Envoy proxy port)
  listener_port: 8080

  # HTTPS listener configuration
  https_enabled: true  # Enable/disable HTTPS listener
  https_port: 8443      # HTTPS listener port

  # Downstream TLS configuration (for HTTPS listener)
  downstream_tls:
    # Path to server certificate (PEM format)
    cert_path: "./listener-certs/default-listener.crt"
    
    # Path to server private key (PEM format)
    key_path: "./listener-certs/default-listener.key"
    
    # Minimum TLS protocol version (TLS1_0, TLS1_1, TLS1_2, TLS1_3)
    minimum_protocol_version: TLS1_2
    
    # Maximum TLS protocol version (TLS1_0, TLS1_1, TLS1_2, TLS1_3)
    maximum_protocol_version: TLS1_3
    
    # Cipher suites (comma-separated)
    ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256,ECDHE-RSA-AES128-GCM-SHA256,ECDHE-ECDSA-AES128-SHA,ECDHE-RSA-AES128-SHA,AES128-GCM-SHA256,AES128-SHA,ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-RSA-AES256-GCM-SHA384,ECDHE-ECDSA-AES256-SHA,ECDHE-RSA-AES256-SHA,AES256-GCM-SHA384,AES256-SHA"

  # Upstream configuration
  envoy_upstream:
    # TLS configuration for upstream connections
    tls:
      minimum_protocol_version: TLS1_2
      maximum_protocol_version: TLS1_3
      ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256,ECDHE-RSA-AES128-GCM-SHA256,ECDHE-ECDSA-AES128-SHA,ECDHE-RSA-AES128-SHA,AES128-GCM-SHA256,AES128-SHA,ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-RSA-AES256-GCM-SHA384,ECDHE-ECDSA-AES256-SHA,ECDHE-RSA-AES256-SHA,AES256-GCM-SHA384,AES256-SHA"
      trusted_cert_path: /etc/ssl/certs/ca-certificates.crt
      custom_certs_path: ./certificates  # Directory containing custom trusted certificates (e.g., self-signed certs)
      verify_host_name: true
      disable_ssl_verification: false

    # Timeout configurations for upstream connections
    timeouts:
      route_timeout_in_seconds: 60
      max_route_timeout_in_seconds: 60
      route_idle_timeout_in_seconds: 300

  # Policy Engine ext_proc filter configuration
  policy_engine:
    # Enable or disable policy engine ext_proc filter
    enabled: true

    # Policy engine host (hostname or IP address)
    host: policy-engine

    # Policy engine ext_proc port
    port: 9001

    # Timeout for gRPC service connection (in milliseconds)
    timeout_ms: 60000

    # Failure mode: false = fail closed (deny requests on error), true = fail open (allow requests on error)
    failure_mode_allow: false

    # Route cache action: DEFAULT, RETAIN, or CLEAR
    # RETAIN: Maintain the route cache across requests (recommended for performance)
    route_cache_action: RETAIN

    # Allow per-route override of ext_proc configuration
    allow_mode_override: true

    # Request header processing mode: DEFAULT, SEND, or SKIP
    # SEND: Forward request headers to policy engine for processing
    request_header_mode: SEND

    # Message timeout for policy engine processing (in milliseconds)
    message_timeout_ms: 60000

    # TLS configuration for policy engine connection
    tls:
      # Enable TLS for secure communication with policy engine
      enabled: false

      # Client certificate path (for mutual TLS authentication)
      cert_path: ""

      # Client private key path (for mutual TLS authentication)
      key_path: ""

      # CA certificate path (for server certificate validation)
      ca_path: ""

      # Server name for SNI (optional, defaults to host)
      server_name: ""

      # Skip server certificate verification (insecure, development only)
      skip_verify: false

# Logging configuration
logging:
  # Log level: "debug", "info", "warn", or "error"
  level: info

  # Log format: "json" or "console"
  # - json: Structured JSON format (recommended for production)
  # - console: Human-readable console format (recommended for development)
  format: json

# Environment Variables Override
# You can override any configuration using environment variables with the prefix GATEWAY_
# Examples:
#   GATEWAY_SERVER_API_PORT=9091
#   GATEWAY_STORAGE_TYPE=memory
#   GATEWAY_STORAGE_SQLITE_PATH=/custom/path/gateway.db
#   GATEWAY_ROUTER_ACCESS_LOGS_ENABLED=false
#   GATEWAY_LOGGING_LEVEL=debug
