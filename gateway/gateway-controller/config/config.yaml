# Gateway-Controller Configuration
# This file contains configuration for the WSO2 API Platform Gateway Controller

# Server configuration
server:
  # REST API port for gateway management
  api_port: 9090

  # xDS gRPC port for Envoy communication
  xds_port: 18000

  # Graceful shutdown timeout
  shutdown_timeout: 15s

# Policy xDS Server configuration
policyserver:
  # Enable or disable the policy xDS server
  enabled: true

  # Policy xDS gRPC port for policy distribution
  port: 18001

# Storage configuration
storage:
  # Storage type: "sqlite", "postgres" (future), or "memory"
  # - sqlite: Use SQLite embedded database for persistence
  # - postgres: Use PostgreSQL database for persistence (future support)
  # - memory: No persistent storage, all configs lost on restart (useful for testing)
  type: sqlite

  # SQLite configuration (used when type=sqlite)
  sqlite:
    path: ./data/gateway.db

# Router (Envoy) configuration
router:
  # Access logs configuration
  access_logs:
    # Enable or disable access logs
    enabled: true

    # Log format: "json" or "text"
    # - json: Structured JSON format (recommended for log aggregation)
    # - text: Human-readable text format
    format: json

    # JSON format fields - key-value pairs for structured logging
    # Uses Envoy command operators: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage
    json_fields:
      start_time: "%START_TIME%"
      method: "%REQ(:METHOD)%"
      path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
      protocol: "%PROTOCOL%"
      response_code: "%RESPONSE_CODE%"
      response_flags: "%RESPONSE_FLAGS%"
      response_flags_long: "%RESPONSE_FLAGS_LONG%"
      bytes_received: "%BYTES_RECEIVED%"
      bytes_sent: "%BYTES_SENT%"
      duration: "%DURATION%"
      upstream_service_time: "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
      x_forwarded_for: "%REQ(X-FORWARDED-FOR)%"
      user_agent: "%REQ(USER-AGENT)%"
      request_id: "%REQ(X-REQUEST-ID)%"
      authority: "%REQ(:AUTHORITY)%"
      upstream_host: "%UPSTREAM_HOST%"
      upstream_cluster: "%UPSTREAM_CLUSTER%"

    # Text format template - used when format is "text"
    # Uses Envoy command operators: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage
    text_format: |
      [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"

  # Listener port for incoming traffic (Envoy proxy port)
  listener_port: 8080

  # Upstream configuration
  envoy_upstream:
    # TLS configuration for upstream connections
    tls:
      minimum_protocol_version: TLS1_2
      maximum_protocol_version: TLS1_3
      ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256,ECDHE-RSA-AES128-GCM-SHA256,ECDHE-ECDSA-AES128-SHA,ECDHE-RSA-AES128-SHA,AES128-GCM-SHA256,AES128-SHA,ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-RSA-AES256-GCM-SHA384,ECDHE-ECDSA-AES256-SHA,ECDHE-RSA-AES256-SHA,AES256-GCM-SHA384,AES256-SHA"
      trusted_cert_path: /etc/ssl/certs/ca-certificates.crt
      verify_host_name: true
      disable_ssl_verification: false

    # Timeout configurations for upstream connections
    timeouts:
      route_timeout_in_seconds: 60
      max_route_timeout_in_seconds: 60
      route_idle_timeout_in_seconds: 300

# Logging configuration
logging:
  # Log level: "debug", "info", "warn", or "error"
  level: info

  # Log format: "json" or "console"
  # - json: Structured JSON format (recommended for production)
  # - console: Human-readable console format (recommended for development)
  format: json

# Environment Variables Override
# You can override any configuration using environment variables with the prefix GATEWAY_
# Examples:
#   GATEWAY_SERVER_API_PORT=9091
#   GATEWAY_STORAGE_TYPE=memory
#   GATEWAY_STORAGE_SQLITE_PATH=/custom/path/gateway.db
#   GATEWAY_ROUTER_ACCESS_LOGS_ENABLED=false
#   GATEWAY_LOGGING_LEVEL=debug
