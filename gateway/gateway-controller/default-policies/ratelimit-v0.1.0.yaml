name: ratelimit
version: v0.1.0
description: |
  Rate limiting policy supporting multiple algorithms (GCRA, Fixed Window), multiple concurrent limits,
  weighted rate limiting, flexible key extraction, and both in-memory and Redis backends. Supports
  fail-open behavior for Redis failures and provides comprehensive rate limit headers (X-RateLimit-*,
  IETF RateLimit, and Retry-After).

  Key features:
  - Multiple algorithms: GCRA (smooth rate limiting) or Fixed Window (simple counter)
  - Weighted rate limiting via cost parameter (different operations consume different quota amounts)
  - Multiple concurrent limits (e.g., 10/second AND 1000/hour)
  - Array-based key extraction with sensible defaults (route name)
  - Dual backends: in-memory (single instance) or Redis (distributed)
  - Graceful degradation: missing key components log warnings but don't fail requests
  - Atomic operations via Lua scripts (GCRA+Redis) or native Redis commands (Fixed Window)

parameters:
  type: object
  additionalProperties: false
  properties:
    limits:
      type: array
      description: |
        Array of rate limit policies to enforce. Multiple limits can be specified to enforce
        different time windows (e.g., 10/second AND 1000/day). All limits are evaluated,
        and the most restrictive limit is enforced.
      minItems: 1
      maxItems: 10
      items:
        type: object
        additionalProperties: false
        required: ["limit", "duration"]
        properties:
          limit:
            type: integer
            description: Maximum number of requests allowed in the duration
            minimum: 1
            maximum: 1000000000
          duration:
            type: string
            description: |
              Time window for the limit (Go duration string format).
              Examples: "1s" (1 second), "1m" (1 minute), "1h" (1 hour), "24h" (1 day)
            pattern: "^[0-9]+(ns|us|Âµs|ms|s|m|h)$"
          burst:
            type: integer
            description: |
              Maximum burst capacity (number of requests that can accumulate).
              If omitted, defaults to the limit value (no burst beyond normal rate).
            minimum: 1
            maximum: 1000000000

    cost:
      type: integer
      description: |
        Number of tokens this operation consumes per request (weighted rate limiting).
        Use this to assign different costs to different operations. For example, simple
        queries might cost 1 token while expensive analytics operations cost 10 tokens.
        If omitted, defaults to 1.
        Note: This is ignored when costExtraction is enabled.
      minimum: 1
      maximum: 1000000
      default: 1

    costExtraction:
      type: object
      description: |
        Configuration for extracting cost from response data (post-response rate limiting).
        When enabled, the actual cost is determined after the upstream responds, allowing
        for dynamic rate limiting based on response content (e.g., token usage from LLM APIs).
        Note: When enabled, requests are NOT blocked pre-request - they always go to upstream.
        Cost is extracted from response and consumed after the response. If rate limit is
        exceeded, the current request already succeeded but headers indicate quota exhaustion.
        Subsequent requests using the same key will be impacted.
      additionalProperties: false
      properties:
        enabled:
          type: boolean
          description: Enable post-response cost extraction
          default: false

        sources:
          type: array
          description: |
            Ordered list of sources to extract cost from. Sources are tried in order
            until one succeeds. If all fail, the default value is used.
          minItems: 1
          maxItems: 5
          items:
            type: object
            additionalProperties: false
            required: ["type"]
            properties:
              type:
                type: string
                description: |
                  Type of source to extract cost from:
                  - response_header: Extract from response header (integer value)
                  - metadata: Extract from shared metadata (set by other policies)
                  - response_body: Extract from JSON response body using jsonPath
                enum: ["response_header", "metadata", "response_body"]

              key:
                type: string
                description: |
                  Header name (for response_header) or metadata key (for metadata).
                  Required for response_header and metadata types.
                minLength: 1
                maxLength: 256

              jsonPath:
                type: string
                description: |
                  JSON path expression for extracting cost from response body.
                  Required for response_body type.
                  Example: "$.usage.total_tokens"
                minLength: 1
                maxLength: 512

        default:
          type: integer
          description: Default cost to use if extraction fails from all sources
          minimum: 1
          maximum: 1000000
          default: 1

    keyExtraction:
      type: array
      description: |
        Array of components to extract and combine for the rate limit key.
        If omitted or empty, defaults to route name.
        Multiple components are joined with ':' separator for composite keys.
      minItems: 0
      maxItems: 5
      items:
        type: object
        additionalProperties: false
        required: ["type"]
        properties:
          type:
            type: string
            description: |
              Type of component to extract:
              - header: Extract from HTTP header (requires 'key' field)
              - metadata: Extract from SharedContext.Metadata (requires 'key' field)
              - ip: Extract client IP from X-Forwarded-For/X-Real-IP
              - apiname: Use API name from context
              - apiversion: Use API version from context
              - routename: Use route name from metadata (default)
            enum: ["header", "metadata", "ip", "apiname", "apiversion", "routename"]
          key:
            type: string
            description: Header name or metadata key (required for header/metadata types)
            minLength: 1
            maxLength: 256

    onRateLimitExceeded:
      type: object
      description: Customize the 429 response when rate limit is exceeded
      additionalProperties: false
      properties:
        statusCode:
          type: integer
          description: HTTP status code for rate limit response
          minimum: 400
          maximum: 599
          default: 429

        body:
          type: string
          description: Custom error message body
          maxLength: 8192
          default: '{"error": "Too Many Requests", "message": "Rate limit exceeded. Please try again later."}'

        bodyFormat:
          type: string
          description: Response body content type
          enum: ["json", "plain"]
          default: "json"

  required: ["limits"]

systemParameters:
  type: object
  additionalProperties: false
  properties:
    algorithm:
      type: string
      description: |
        Rate limiting algorithm to use:
        - gcra: Generic Cell Rate Algorithm (default). Provides smooth rate limiting
          with burst support and token bucket semantics. Better for consistent traffic
          shaping and burst handling.
        - fixed-window: Simple fixed time window counter. Divides time into fixed
          intervals and counts requests per window. Lower computational overhead,
          but can allow up to 2x burst at window boundaries.
      enum: ["gcra", "fixed-window"]
      default: "gcra"
      "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.algorithm}"

    backend:
      type: string
      description: |
        Rate limit storage backend. 'memory' for in-memory storage (single-instance),
        'redis' for distributed rate limiting across multiple gateway instances.
      enum: ["memory", "redis"]
      default: "memory"
      "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.backend}"

    redis:
      type: object
      description: Redis configuration (only used when backend=redis)
      additionalProperties: false
      properties:
        host:
          type: string
          description: Redis server hostname or IP address
          default: "localhost"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.host}"

        port:
          type: integer
          description: Redis server port
          minimum: 1
          maximum: 65535
          default: 6379
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.port}"

        password:
          type: string
          description: Redis authentication password (optional)
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.password}"

        username:
          type: string
          description: Redis ACL username (optional, Redis 6+)
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.username}"

        db:
          type: integer
          description: Redis database number
          minimum: 0
          maximum: 15
          default: 0
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.db}"

        keyPrefix:
          type: string
          description: Prefix for all Redis keys to avoid conflicts
          default: "ratelimit:v1:"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.keyprefix}"

        failureMode:
          type: string
          description: |
            Behavior when Redis is unavailable. 'open' allows requests through,
            'closed' denies requests. Recommended: 'open' for availability.
          enum: ["open", "closed"]
          default: "open"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.failuremode}"

        connectionTimeout:
          type: string
          description: Redis connection timeout (Go duration string)
          default: "5s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.connectiontimeout}"

        readTimeout:
          type: string
          description: Redis read timeout (Go duration string)
          default: "3s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.readtimeout}"

        writeTimeout:
          type: string
          description: Redis write timeout (Go duration string)
          default: "3s"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.redis.writetimeout}"

    memory:
      type: object
      description: In-memory storage configuration (only used when backend=memory)
      additionalProperties: false
      properties:
        maxEntries:
          type: integer
          description: |
            Maximum number of rate limit entries to store in memory.
            Oldest entries are evicted when limit is reached.
          minimum: 100
          maximum: 10000000
          default: 10000
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.memory.maxentries}"

        cleanupInterval:
          type: string
          description: |
            Interval for cleaning up expired entries (Go duration string).
            Use "0" to disable periodic cleanup.
          default: "5m"
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.memory.cleanupinterval}"

    headers:
      type: object
      description: Control which rate limit headers are included in responses
      additionalProperties: false
      properties:
        includeXRateLimit:
          type: boolean
          description: |
            Include X-RateLimit-* headers (de facto industry standard).
            Headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset
          default: true
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.headers.includexratelimit}"

        includeIETF:
          type: boolean
          description: |
            Include IETF RateLimit headers (draft standard).
            Headers: RateLimit-Limit, RateLimit-Remaining, RateLimit-Reset, RateLimit-Policy
          default: true
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.headers.includeietf}"

        includeRetryAfter:
          type: boolean
          description: |
            Include Retry-After header when rate limited (RFC 7231).
            Only set on 429 responses.
          default: true
          "wso2/defaultValue": "${config.policy_configurations.ratelimit_v010.headers.includeretryafter}"
