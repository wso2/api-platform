// Code generated by Policy Engine Builder. DO NOT EDIT.
package main

import (
	"context"
	"log/slog"
	"os"

	"github.com/policy-engine/policy-engine/internal/registry"
	policy "github.com/wso2/api-platform/sdk/gateway/policy/v1alpha"
{{- range .Policies }}
	{{ .ImportAlias }} "{{ .ImportPath }}"
{{- end }}
)

func init() {
	// Set up JSON logger early so init() logs match main() logs
	slog.SetDefault(slog.New(slog.NewJSONHandler(os.Stdout, &slog.HandlerOptions{Level: slog.LevelInfo})))
	
	ctx := context.Background()
	slog.InfoContext(ctx, "Registering policies from Builder compilation")

	{{- range .Policies }}
	// Register {{ .Name }} {{ .Version }}
	policyDef_{{ .ImportAlias }} := &policy.PolicyDefinition{
		Name:    "{{ .Name }}",
		Version: "{{ .Version }}",
	}
	if err := registry.GetRegistry().Register(policyDef_{{ .ImportAlias }}, {{ .ImportAlias }}.NewPolicy); err != nil {
		slog.ErrorContext(ctx, "Failed to register policy", "policy", "{{ .Name }}", "version", "{{ .Version }}", "error", err)
	} else {
		slog.InfoContext(ctx, "Registered policy", "policy", "{{ .Name }}", "version", "{{ .Version }}")
	}
	{{- end }}
}
