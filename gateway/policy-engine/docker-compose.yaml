# --------------------------------------------------------------------
# Copyright (c) 2025, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# --------------------------------------------------------------------

version: "3.8"

services:
  # T098: Envoy Proxy with ext_proc filter pointing to policy-engine
  envoy:
    image: envoyproxy/envoy:v1.36.2
    container_name: envoy-proxy
    volumes:
      - ./configs/envoy.yaml:/etc/envoy/envoy.yaml
    command: /usr/local/bin/envoy -c /etc/envoy/envoy.yaml --service-cluster front-proxy --file-flush-interval-msec 50
    ports:
      - "8000:8000"  # HTTP proxy port
      - "9901:9901"  # Admin interface
    networks:
      - policy-network

  # T099: Policy Engine Service (ext_proc + xDS)
  policy-engine:
    image: policy-engine:custom
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    # container_name: policy-engine
    volumes:
      - ./configs:/configs
      - ./policies:/policies
    command: ["-extproc-port=9001", "-config-file=/configs/policy-chains.yaml"]
    ports:
      - "9001:9001"  # ext_proc gRPC server
      - "9002:9002"  # xDS gRPC server (future)
    networks:
      - policy-network

  # T100: Test backend service (request-info container)
  request_info:
    image: renukafernando/request-info:latest
    container_name: request_info
    command: ["-addr", ":8080", "-logH", "-logB", "-pretty"]
    environment:
      - NAME=Test-Backend
    ports:
      - "8080:8080"
    networks:
      - policy-network

networks:
  policy-network:
    driver: bridge

# T101: Volume mounts for configs/ directory
volumes:
  configs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./configs
