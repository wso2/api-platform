name: SemanticPromptGuard
version: v1.0.0
description: |
  Blocks or allows prompts based on semantic similarity to configured allow/deny
  phrase embeddings. The incoming prompt is embedded via the configured endpoint
  and compared using cosine distance against pre-computed vectors.

parameters:
  user:
    - name: embeddingEndpoint
      type: string
      required: true
      description: |
        HTTP endpoint that returns an embedding for a given prompt. The policy
        POSTs {"input": "<prompt>"} as JSON and expects an "embedding" array
        (or data[0].embedding) in the response. For azure-openai, set this to
        your Azure OpenAI endpoint base (e.g., https://myres.openai.azure.com).
      validation:
        format: uri

    - name: provider
      type: string
      required: false
      default: azure-openai
      description: |
        Embedding provider to call. Supported: azure-openai, openai.
      validation:
        enum:
          - azure-openai
          - openai

    - name: apiKey
      type: string
      required: true
      description: API key for the embedding provider.

    - name: azureDeployment
      type: string
      required: false
      description: |
        Azure OpenAI deployment name (required when provider=azure-openai).
      validation:
        minLength: 1
        maxLength: 256

    - name: azureAPIVersion
      type: string
      required: false
      default: "2023-05-15"
      description: |
        Azure OpenAI API version query param (provider=azure-openai).
      validation:
        minLength: 5
        maxLength: 32

    - name: openAIModel
      type: string
      required: false
      description: |
        OpenAI embedding model (e.g., text-embedding-3-small) when provider=openai.
      validation:
        minLength: 1
        maxLength: 256

    - name: promptField
      type: string
      required: false
      default: prompt
      description: |
        JSON field name in the request body that contains the prompt. If not
        provided, the entire body is treated as the prompt string.
      validation:
        minLength: 1
        maxLength: 256

    - name: allowDistanceThreshold
      type: float
      required: false
      default: 0.35
      description: |
        Maximum cosine distance for a prompt to be considered similar to an
        allowed phrase. Smaller values mean stricter matching.

    - name: denyDistanceThreshold
      type: float
      required: false
      default: 0.35
      description: |
        Maximum cosine distance for a prompt to be considered similar to a
        denied phrase. If any denied phrase is within this distance, the
        request is blocked.

    - name: showAssessment
      type: boolean
      required: false
      default: false
      description: |
        When true, the policy returns a detailed blocking assessment (reason
        and distance) when a prompt is blocked. When false, the policy returns
        a generic error message without details. Default is false.

    - name: timeoutMs
      type: integer
      required: false
      default: 5000
      description: |
        Timeout in milliseconds for the embedding endpoint request.
      validation:
        minimum: 1
        maximum: 60000

    - name: allowedPhrases
      type: array
      required: false
      description: |
        Pre-computed embeddings that are considered safe. If provided and
        requireAllowedMatch is true, the prompt must match one of these within
        allowDistanceThreshold.
      items:
        type: object
        properties:
          - name: phrase
            type: string
            required: false
            description: Phrase text (used for embedding when embedding is absent).
          - name: embedding
            type: array
            required: false
            description: Pre-computed embedding vector for the phrase.
            items:
              type: float

    - name: deniedPhrases
      type: array
      required: false
      description: |
        Pre-computed embeddings that should block the prompt when similar
        within the denyDistanceThreshold.
      items:
        type: object
        properties:
          - name: phrase
            type: string
            required: false
            description: Phrase text (used for embedding when embedding is absent).
          - name: embedding
            type: array
            required: false
            description: Pre-computed embedding vector for the phrase.
            items:
              type: float


