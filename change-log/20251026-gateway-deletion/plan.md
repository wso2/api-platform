# Implementation Plan: Gateway Deletion

**Branch**: `004-gateway-deletion` | **Date**: 2025-10-23 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/004-gateway-deletion/spec.md`

## Summary

This feature implements secure gateway deletion functionality that removes gateways and their associated tokens from the system. The implementation follows the existing gateway management patterns with JWT-based authentication, organization isolation, and safety checks to prevent deletion of actively-used gateways. The deletion operation is permanent (hard delete with CASCADE), blocked when active API deployments or WebSocket connections exist, and fully audited for compliance tracking.

**Key Technical Approach**:
- Extend existing gateway handler, service, and repository layers
- Leverage existing CASCADE delete constraints in database schema
- Implement pre-deletion validation checks (deployments, connections)
- Add structured logging with correlation IDs and Prometheus metrics
- Integrate with audit trail system for compliance tracking

## Technical Context

**Language/Version**: Go 1.25.1 (matches existing platform-api implementation)
**Primary Dependencies**:
- `github.com/gin-gonic/gin` (existing HTTP framework)
- `github.com/mattn/go-sqlite3` (existing database driver)
- `go.uber.org/zap` (structured logging, assumed available)
- `github.com/prometheus/client_golang` (metrics, assumed available)

**Storage**: SQLite with existing `gateways` and `gateway_tokens` tables (CASCADE delete already configured)
**Testing**: Manual verification with curl commands (test framework TBD per constitution)
**Target Platform**: Linux server (containerized with Docker)
**Project Type**: Single backend service (existing platform-api)
**Performance Goals**: <2 seconds deletion latency, <5 seconds user-perceived
**Constraints**: Transaction atomicity required, no partial deletions allowed
**Scale/Scope**: Organization-scoped operations, multi-tenant isolation enforced

## Constitution Check

**GATE STATUS**: ✅ PASS

### I. Specification-First Development ✅
- Feature specification complete in `spec.md`
- Implementation plan in `plan.md` (this file)
- OpenAPI contract will be updated in `src/resources/openapi.yaml`
- Implementation documentation will follow in `spec/impls/gateway-management/gateway-deletion.md`

### II. Layered Architecture ✅
- **Handler Layer**: Extends `internal/handler/gateway.go` with DELETE endpoint
- **Service Layer**: Extends `internal/service/gateway.go` with deletion logic
- **Repository Layer**: Extends `internal/repository/gateway.go` with delete operations
- **DTOs**: No new DTOs required (uses existing Gateway model for audit)

### III. Security by Default ✅
- JWT authentication required (existing middleware `internal/middleware/auth.go`)
- Organization isolation enforced (existing pattern)
- Input validation for UUID format
- Structured error responses without sensitive details
- Audit trail for all deletion attempts

### IV. Documentation Traceability ✅
- Spec → Plan → Implementation docs chain maintained
- Verification curl commands included in quickstart
- Entry points documented in implementation notes

### V. RESTful API Standards ✅
- DELETE `/api/v1/gateways/{gatewayId}` endpoint
- Standard HTTP semantics: DELETE for resource removal
- camelCase property names in responses
- Proper status codes: 204 No Content, 404 Not Found, 409 Conflict, 401 Unauthorized
- Idempotent operation (404 on re-deletion)

### VI. Data Integrity ✅
- CASCADE delete already configured in schema (`ON DELETE CASCADE`)
- Transaction-wrapped deletion (atomicity guaranteed)
- No partial deletions possible
- Pre-deletion validation checks prevent data inconsistencies

### VII. Container-First Operations ✅
- Extends existing containerized platform-api service
- No new container requirements
- Metrics exposed via existing Prometheus endpoint
- Structured JSON logs to stdout (existing pattern)

**Constitution Compliance**: Full compliance with no violations or deviations.

## Project Structure

### Documentation (this feature)

```text
specs/004-gateway-deletion/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0: Technology decisions and patterns
├── data-model.md        # Phase 1: Entities, validation rules
├── quickstart.md        # Phase 1: Deployment and verification guide
├── contracts/           # Phase 1: OpenAPI contract additions
│   └── gateway-delete.yaml
├── checklists/          # Generated by /speckit.specify
│   └── requirements.md
└── tasks.md             # Phase 2: Generated by /speckit.tasks command
```

### Source Code (platform-api)

```text
platform-api/src/
├── cmd/
│   └── main.go                      # Entry point (no changes)
├── internal/
│   ├── handler/
│   │   └── gateway.go               # MODIFY: Add DeleteGateway handler
│   ├── service/
│   │   ├── gateway.go               # MODIFY: Add DeleteGateway service method
│   │   ├── deployment.go            # EXISTING: Query active deployments
│   │   ├── websocket.go             # EXISTING: Query active connections
│   │   └── audit.go                 # EXISTING or NEW: Audit trail integration
│   ├── repository/
│   │   ├── gateway.go               # MODIFY: Add Delete repository method
│   │   ├── deployment.go            # EXISTING: Count deployments by gateway
│   │   └── websocket.go             # EXISTING: Count connections by gateway
│   ├── model/
│   │   ├── gateway.go               # EXISTING: Gateway domain model
│   │   └── audit.go                 # EXISTING or NEW: Audit event model
│   ├── dto/
│   │   └── error.go                 # EXISTING: Structured error responses
│   ├── middleware/
│   │   └── auth.go                  # EXISTING: JWT authentication
│   └── database/
│       └── schema.sql               # NO CHANGES: CASCADE delete already configured
└── resources/
    └── openapi.yaml                 # MODIFY: Add DELETE /api/v1/gateways/{gatewayId}
```

**Structure Decision**: Extends existing single backend service (platform-api) using established layered architecture. No new packages required. All changes integrate with existing gateway management infrastructure.

## Complexity Tracking

**No violations detected** - All constitution principles satisfied without deviation.
