name: Periodic Gateway Build

on:
  schedule:
    - cron: '0 * * * *' # run every hour
  workflow_dispatch:

jobs:
  hourly-build:
    name: Periodic Gateway Build
    runs-on: ubuntu-latest

    env:
      BUILDX_BUILDER: docker-container

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # ------------------------------------------------------------
      # FIX: Explicitly create a Buildx builder NAMED "docker-container"
      # ------------------------------------------------------------
      - name: Set up Docker Buildx (named builder)
        run: |
          set -e

          if ! docker buildx inspect docker-container >/dev/null 2>&1; then
            docker buildx create \
              --name docker-container \
              --driver docker-container
          fi

          docker buildx use docker-container
          docker buildx inspect --bootstrap
          docker buildx ls

      - name: Build gateway
        working-directory: ./gateway
        run: |
          set -o pipefail
          : > "$GITHUB_WORKSPACE/gateway-build.log"
          (make build) 2>&1 | tee "$GITHUB_WORKSPACE/gateway-build.log"

      - name: Build CLI
        working-directory: ./cli/src
        run: |
          set -o pipefail
          : > "$GITHUB_WORKSPACE/cli-build.log"
          (make build-all) 2>&1 | tee "$GITHUB_WORKSPACE/cli-build.log"

      - name: Prepare my-gw run directory
        run: |
          rm -rf my-gw
          mkdir my-gw

          if [ -f cli/src/build/ap-linux-amd64 ]; then
            cp cli/src/build/ap-linux-amd64 my-gw/ap
          else
            cp cli/src/build/ap-linux-amd64-v* my-gw/ap
          fi

          chmod +x my-gw/ap

          if [ -f cli/src/tests/resources/simple-policy-manifest.yaml ]; then
            cp cli/src/tests/resources/simple-policy-manifest.yaml my-gw/policy-manifest.yaml
          fi

      - name: Run ap gateway image build (smoke test)
        working-directory: ./my-gw
        env:
          CI: ""
          WSO2AP_GW_USERNAME: ${{ secrets.WSO2AP_GW_USERNAME || '' }}
          WSO2AP_GW_PASSWORD: ${{ secrets.WSO2AP_GW_PASSWORD || '' }}
        run: |
          mkdir -p "$HOME/.wso2ap/.tmp/gateway-image-build/logs"
          ./ap gateway image build

      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: gateway-build-logs
          path: |
            gateway-build.log
            cli-build.log
            .wso2ap/.tmp/gateway-image-build/logs/docker.log
