---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
    kompose.version: 1.37.0 (HEAD)
  labels:
    io.kompose.service: gateway-controller
    app.kubernetes.io/name: {{ .GatewayName }}
    app.kubernetes.io/component: gateway-controller
  name: {{ .GatewayName }}-gateway-controller
spec:
  ports:
    - name: "9090"
      port: 9090
      targetPort: 9090
    - name: "18000"
      port: 18000
      targetPort: 18000
  selector:
    io.kompose.service: gateway-controller
    app.kubernetes.io/name: {{ .GatewayName }}

---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
    kompose.version: 1.37.0 (HEAD)
  labels:
    io.kompose.service: router
    app.kubernetes.io/name: {{ .GatewayName }}
    app.kubernetes.io/component: router
  name: {{ .GatewayName }}-router
spec:
  ports:
    - name: "8080"
      port: 8080
      targetPort: 8080
    - name: "9901"
      port: 9901
      targetPort: 9901
  selector:
    io.kompose.service: router
    app.kubernetes.io/name: {{ .GatewayName }}

---
apiVersion: v1
kind: Service
metadata:
  annotations:
    kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
    kompose.version: 1.37.0 (HEAD)
  labels:
    io.kompose.service: sample-backend
    app.kubernetes.io/name: {{ .GatewayName }}
    app.kubernetes.io/component: sample-backend
  name: {{ .GatewayName }}-sample-backend
spec:
  ports:
    - name: "5000"
      port: 5000
      targetPort: 5000
  selector:
    io.kompose.service: sample-backend
    app.kubernetes.io/name: {{ .GatewayName }}

---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
    kompose.version: 1.37.0 (HEAD)
  labels:
    io.kompose.service: gateway-controller
    app.kubernetes.io/name: {{ .GatewayName }}
    app.kubernetes.io/component: gateway-controller
  name: {{ .GatewayName }}-gateway-controller
spec:
  replicas: {{ .Replicas }}
  selector:
    matchLabels:
      io.kompose.service: gateway-controller
      app.kubernetes.io/name: {{ .GatewayName }}
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
        kompose.version: 1.37.0 (HEAD)
      labels:
        io.kompose.service: gateway-controller
        app.kubernetes.io/name: {{ .GatewayName }}
        app.kubernetes.io/component: gateway-controller
    spec:
      containers:
        - env:
            - name: GATEWAY_CONTROLPLANE_HOST
              value: {{ .ControlPlaneHost }}
            - name: GATEWAY_CONTROLPLANE_TOKEN
              {{- if .ControlPlaneTokenSecret }}
              valueFrom:
                secretKeyRef:
                  name: {{ .ControlPlaneTokenSecret.Name }}
                  key: {{ .ControlPlaneTokenSecret.Key }}
              {{- else }}
              value: ""
              {{- end }}
            - name: GATEWAY_LOGGING_LEVEL
              value: {{ .LogLevel }}
            - name: GATEWAY_STORAGE_SQLITE_PATH
              value: {{ .StorageSQLitePath }}
            - name: GATEWAY_STORAGE_TYPE
              value: {{ .StorageType }}
          image: {{ .GatewayImage }}
          imagePullPolicy: IfNotPresent
          livenessProbe:
            httpGet:
              path: /health
              port: 9090
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 9090
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
          name: gateway-controller
          ports:
            - containerPort: 9090
              protocol: TCP
            - containerPort: 18000
              protocol: TCP
          {{- if .Resources }}
          resources:
            {{- if .Resources.Requests }}
            requests:
              {{- if .Resources.Requests.CPU }}
              cpu: {{ .Resources.Requests.CPU }}
              {{- end }}
              {{- if .Resources.Requests.Memory }}
              memory: {{ .Resources.Requests.Memory }}
              {{- end }}
            {{- end }}
            {{- if .Resources.Limits }}
            limits:
              {{- if .Resources.Limits.CPU }}
              cpu: {{ .Resources.Limits.CPU }}
              {{- end }}
              {{- if .Resources.Limits.Memory }}
              memory: {{ .Resources.Limits.Memory }}
              {{- end }}
            {{- end }}
          {{- end }}
          volumeMounts:
            - mountPath: /app/data
              name: controller-data
            - mountPath: /app/config/config.yaml
              name: gateway-controller-config
              readOnly: true
              subPath: config.yaml
      {{- if .NodeSelector }}
      nodeSelector:
        {{- range $key, $value := .NodeSelector }}
        {{ $key }}: {{ $value }}
        {{- end }}
      {{- end }}
      {{- if .Tolerations }}
      tolerations:
        {{- range .Tolerations }}
        - key: {{ .Key }}
          operator: {{ .Operator }}
          {{- if .Value }}
          value: {{ .Value }}
          {{- end }}
          effect: {{ .Effect }}
        {{- end }}
      {{- end }}
      {{- if .Affinity }}
      affinity:
        {{- toYaml .Affinity | nindent 8 }}
      {{- end }}
      restartPolicy: Always
      volumes:
        - name: controller-data
          persistentVolumeClaim:
            claimName: {{ .GatewayName }}-controller-data
        - configMap:
            items:
              - key: config.yaml
                path: config.yaml
            name: {{ .GatewayName }}-gateway-controller-config
          name: gateway-controller-config

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    io.kompose.service: controller-data
    app.kubernetes.io/name: {{ .GatewayName }}
  name: {{ .GatewayName }}-controller-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Mi

---
apiVersion: v1
data:
  config.yaml: |
    # Gateway-Controller Configuration
    # This file contains configuration for the WSO2 API Platform Gateway Controller

    # Server configuration
    server:
      # REST API port for gateway management
      api_port: 9090

      # xDS gRPC port for Envoy communication
      xds_port: 18000

      # Graceful shutdown timeout
      shutdown_timeout: 15s

    # Storage configuration
    storage:
      # Storage type: "sqlite", "postgres" (future), or "memory"
      # - sqlite: Use SQLite embedded database for persistence
      # - postgres: Use PostgreSQL database for persistence (future support)
      # - memory: No persistent storage, all configs lost on restart (useful for testing)
      type: {{ .StorageType }}

      # SQLite configuration (used when type=sqlite)
      sqlite:
        path: {{ .StorageSQLitePath }}

    # Router (Envoy) configuration
    router:
      # Access logs configuration
      access_logs:
        # Enable or disable access logs
        enabled: true

        # Log format: "json" or "text"
        # - json: Structured JSON format (recommended for log aggregation)
        # - text: Human-readable text format
        format: json

        # JSON format fields - key-value pairs for structured logging
        # Uses Envoy command operators: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage
        json_fields:
          start_time: "%START_TIME%"
          method: "%REQ(:METHOD)%"
          path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
          protocol: "%PROTOCOL%"
          response_code: "%RESPONSE_CODE%"
          response_flags: "%RESPONSE_FLAGS%"
          response_flags_long: "%RESPONSE_FLAGS_LONG%"
          bytes_received: "%BYTES_RECEIVED%"
          bytes_sent: "%BYTES_SENT%"
          duration: "%DURATION%"
          upstream_service_time: "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
          x_forwarded_for: "%REQ(X-FORWARDED-FOR)%"
          user_agent: "%REQ(USER-AGENT)%"
          request_id: "%REQ(X-REQUEST-ID)%"
          authority: "%REQ(:AUTHORITY)%"
          upstream_host: "%UPSTREAM_HOST%"
          upstream_cluster: "%UPSTREAM_CLUSTER%"

        # Text format template - used when format is "text"
        # Uses Envoy command operators: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage
        text_format: |
          [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"

      # Listener port for incoming traffic (Envoy proxy port)
      listener_port: 8080

    # Logging configuration
    logging:
      # Log level: "debug", "info", "warn", or "error"
      level: {{ .LogLevel }}

      # Log format: "json" or "console"
      # - json: Structured JSON format (recommended for production)
      # - console: Human-readable console format (recommended for development)
      format: json

    # Environment Variables Override
    # You can override any configuration using environment variables with the prefix GATEWAY_
    # Examples:
    #   GATEWAY_SERVER_API_PORT=9091
    #   GATEWAY_STORAGE_TYPE=memory
    #   GATEWAY_STORAGE_SQLITE_PATH=/custom/path/gateway.db
    #   GATEWAY_ROUTER_ACCESS_LOGS_ENABLED=false
    #   GATEWAY_LOGGING_LEVEL=debug
kind: ConfigMap
metadata:
  annotations:
    use-subpath: "true"
  labels:
    io.kompose.service: gateway-controller
    app.kubernetes.io/name: {{ .GatewayName }}
  name: {{ .GatewayName }}-gateway-controller-config

---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
    kompose.version: 1.37.0 (HEAD)
  labels:
    io.kompose.service: router
    app.kubernetes.io/name: {{ .GatewayName }}
    app.kubernetes.io/component: router
  name: {{ .GatewayName }}-router
spec:
  replicas: {{ .Replicas }}
  selector:
    matchLabels:
      io.kompose.service: router
      app.kubernetes.io/name: {{ .GatewayName }}
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
        kompose.version: 1.37.0 (HEAD)
      labels:
        io.kompose.service: router
        app.kubernetes.io/name: {{ .GatewayName }}
        app.kubernetes.io/component: router
    spec:
      containers:
        - env:
            - name: XDS_SERVER_HOST
              value: {{ .GatewayName }}-gateway-controller
            - name: XDS_SERVER_PORT
              value: "18000"
          image: {{ .RouterImage }}
          imagePullPolicy: IfNotPresent
          livenessProbe:
            httpGet:
              path: /ready
              port: 9901
            failureThreshold: 3
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /ready
              port: 9901
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
          name: router
          ports:
            - containerPort: 8080
              protocol: TCP
            - containerPort: 9901
              protocol: TCP
          {{- if .Resources }}
          resources:
            {{- if .Resources.Requests }}
            requests:
              {{- if .Resources.Requests.CPU }}
              cpu: {{ .Resources.Requests.CPU }}
              {{- end }}
              {{- if .Resources.Requests.Memory }}
              memory: {{ .Resources.Requests.Memory }}
              {{- end }}
            {{- end }}
            {{- if .Resources.Limits }}
            limits:
              {{- if .Resources.Limits.CPU }}
              cpu: {{ .Resources.Limits.CPU }}
              {{- end }}
              {{- if .Resources.Limits.Memory }}
              memory: {{ .Resources.Limits.Memory }}
              {{- end }}
            {{- end }}
          {{- end }}
      {{- if .NodeSelector }}
      nodeSelector:
        {{- range $key, $value := .NodeSelector }}
        {{ $key }}: {{ $value }}
        {{- end }}
      {{- end }}
      {{- if .Tolerations }}
      tolerations:
        {{- range .Tolerations }}
        - key: {{ .Key }}
          operator: {{ .Operator }}
          {{- if .Value }}
          value: {{ .Value }}
          {{- end }}
          effect: {{ .Effect }}
        {{- end }}
      {{- end }}
      {{- if .Affinity }}
      affinity:
        {{- toYaml .Affinity | nindent 8 }}
      {{- end }}
      restartPolicy: Always

---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
    kompose.version: 1.37.0 (HEAD)
  labels:
    io.kompose.service: sample-backend
    app.kubernetes.io/name: {{ .GatewayName }}
    app.kubernetes.io/component: sample-backend
  name: {{ .GatewayName }}-sample-backend
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: sample-backend
      app.kubernetes.io/name: {{ .GatewayName }}
  template:
    metadata:
      annotations:
        kompose.cmd: kompose convert -f docker-compose.yaml -o all-in-one.yaml
        kompose.version: 1.37.0 (HEAD)
      labels:
        io.kompose.service: sample-backend
        app.kubernetes.io/name: {{ .GatewayName }}
        app.kubernetes.io/component: sample-backend
    spec:
      containers:
        - args:
            - "-text=Hello from {{ .GatewayName }} sample backend! Request received successfully."
            - "-listen=:5000"
          image: hashicorp/http-echo:latest
          name: sample-backend
          ports:
            - containerPort: 5000
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: 5000
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 5000
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
      restartPolicy: Always
