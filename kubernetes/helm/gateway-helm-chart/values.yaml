# Default values for the Open Choreo Gateway chart.
# This file is intended to be exhaustive and well documented; adjust per environment.

nameOverride: ""
fullnameOverride: ""

imagePullSecrets: []

commonLabels: {}
commonAnnotations: {}

serviceAccount:
  create: true
  annotations: {}
  name: ""

## moved to each component's deployment block below

# Component-level configuration

gateway:
  # Shared configuration mounted as:
  #   - gateway-controller: /etc/gateway-controller/config.toml
  #   - gateway-runtime (policy engine): /etc/policy-engine/config.toml
  config:
    gateway_controller:
      auth:
        basic:
          enabled: true
          users:
            - username: "admin"
              password: "admin"
              password_hashed: false
              roles: ["admin"]
        idp:
          enabled: false
          jwks_url: ""
          issuer: ""
          roles_claim: "scope"
          role_mapping: {}
      # Server configuration
      server:
        # REST API port for gateway management
        api_port: 9090

        # xDS gRPC port for Envoy communication
        xds_port: 18000

        # Graceful shutdown timeout
        shutdown_timeout: 15s

      # Policy xDS Server configuration
      policyserver:
        # Enable or disable the policy xDS server
        enabled: true

        # Policy xDS gRPC port for policy distribution
        port: 18001

        # TLS configuration for secure policy xDS communication
        tls:
          # Enable or disable TLS
          enabled: false

          # Path to TLS certificate file (required if TLS is enabled)
          cert_file: "./certs/server.crt"

          # Path to TLS private key file (required if TLS is enabled)
          key_file: "./certs/server.key"

      # Storage configuration
      storage:
        # Storage type: "sqlite", "postgres" (future), or "memory"
        # - sqlite: Use SQLite embedded database for persistence
        # - postgres: Use PostgreSQL database for persistence (future support)
        # - memory: No persistent storage, all configs lost on restart (useful for testing)
        type: sqlite

        # SQLite configuration (used when type=sqlite)
        sqlite:
          path: ./data/gateway.db

      # Policy configuration
      policies:
        # Directory containing policy definitions
        definitions_path: ./default-policies

      # Router (Envoy) configuration
      router:
        # Gateway host for incoming requests
        gateway_host: "*"

        # Access logs configuration
        access_logs:
          # Enable or disable access logs
          enabled: true

          # Log format: "json" or "text"
          # - json: Structured JSON format (recommended for log aggregation)
          # - text: Human-readable text format
          format: json

          # JSON format fields - key-value pairs for structured logging
          # Uses Envoy command operators: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage
          json_fields:
            start_time: "%START_TIME%"
            method: "%REQ(:METHOD)%"
            path: "%REQ(X-ENVOY-ORIGINAL-PATH?:PATH)%"
            protocol: "%PROTOCOL%"
            response_code: "%RESPONSE_CODE%"
            response_flags: "%RESPONSE_FLAGS%"
            response_flags_long: "%RESPONSE_FLAGS_LONG%"
            bytes_received: "%BYTES_RECEIVED%"
            bytes_sent: "%BYTES_SENT%"
            duration: "%DURATION%"
            upstream_service_time: "%RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)%"
            x_forwarded_for: "%REQ(X-FORWARDED-FOR)%"
            user_agent: "%REQ(USER-AGENT)%"
            request_id: "%REQ(X-REQUEST-ID)%"
            authority: "%REQ(:AUTHORITY)%"
            upstream_host: "%UPSTREAM_HOST%"
            upstream_cluster: "%UPSTREAM_CLUSTER%"

          # Text format template - used when format is "text"
          # Uses Envoy command operators: https://www.envoyproxy.io/docs/envoy/latest/configuration/observability/access_log/usage
          text_format: |
            [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"

        # Listener port for incoming HTTP traffic (Envoy proxy port)
        listener_port: 8080

        # HTTPS listener configuration
        https_enabled: true  # Enable/disable HTTPS listener
        https_port: 8443      # HTTPS listener port

        # Downstream TLS configuration (for HTTPS listener)
        downstream_tls:
          # Path to server certificate (PEM format)
          cert_path: "./listener-certs/default-listener.crt"

          # Path to server private key (PEM format)
          key_path: "./listener-certs/default-listener.key"

          # Minimum TLS protocol version (TLS1_0, TLS1_1, TLS1_2, TLS1_3)
          minimum_protocol_version: TLS1_2

          # Maximum TLS protocol version (TLS1_0, TLS1_1, TLS1_2, TLS1_3)
          maximum_protocol_version: TLS1_3

          # Cipher suites (comma-separated)
          ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256,ECDHE-RSA-AES128-GCM-SHA256,ECDHE-ECDSA-AES128-SHA,ECDHE-RSA-AES128-SHA,AES128-GCM-SHA256,AES128-SHA,ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-RSA-AES256-GCM-SHA384,ECDHE-ECDSA-AES256-SHA,ECDHE-RSA-AES256-SHA,AES256-GCM-SHA384,AES256-SHA"

        # Upstream configuration
        envoy_upstream:
          # TLS configuration for upstream connections
          tls:
            minimum_protocol_version: TLS1_2
            maximum_protocol_version: TLS1_3
            ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256,ECDHE-RSA-AES128-GCM-SHA256,ECDHE-ECDSA-AES128-SHA,ECDHE-RSA-AES128-SHA,AES128-GCM-SHA256,AES128-SHA,ECDHE-ECDSA-AES256-GCM-SHA384,ECDHE-RSA-AES256-GCM-SHA384,ECDHE-ECDSA-AES256-SHA,ECDHE-RSA-AES256-SHA,AES256-GCM-SHA384,AES256-SHA"
            trusted_cert_path: /etc/ssl/certs/ca-certificates.crt
            custom_certs_path: ./certificates  # Directory containing custom trusted certificates (e.g., self-signed certs)
            verify_host_name: true
            disable_ssl_verification: false

          # Timeout configurations for upstream connections
          timeouts:
            route_timeout_in_seconds: 60
            max_route_timeout_in_seconds: 60
            route_idle_timeout_in_seconds: 300
        
        tracing_service_name: router

        # Policy Engine ext_proc filter configuration
        policy_engine:
          # Enable or disable policy engine ext_proc filter
          enabled: true

          # Connection mode: "uds" (Unix domain socket, default) or "tcp"
          mode: uds

          # Timeout for gRPC service connection (in milliseconds)
          timeout_ms: 60000

          # Failure mode: false = fail closed (deny requests on error), true = fail open (allow requests on error)
          failure_mode_allow: false

          # Route cache action: DEFAULT, RETAIN, or CLEAR
          # RETAIN: Maintain the route cache across requests (recommended for performance)
          route_cache_action: RETAIN

          # Allow per-route override of ext_proc configuration
          allow_mode_override: true

          # Request header processing mode: DEFAULT, SEND, or SKIP
          # SEND: Forward request headers to policy engine for processing
          request_header_mode: SEND

          # Message timeout for policy engine processing (in milliseconds)
          message_timeout_ms: 60000

      # Logging configuration
      logging:
        # Log level: "debug", "info", "warn", or "error"
        level: debug

        # Log format: "json" or "text"
        # - json: Structured JSON format (recommended for production)
        # - text: Human-readable text format (recommended for development)
        format: json

    policy_engine:
      server:
        # ext_proc socket path â€” must match the constant in the gateway-runtime image
        extproc_socket: /var/run/policy-engine.sock

      # Admin HTTP server configuration
      admin:
        # Enable admin HTTP server for debugging endpoints
        enabled: true

        # Port for admin HTTP server
        port: 9002

        # IP addresses allowed to access the admin API
        # Defaults to localhost only for security
        allowed_ips:
          - "*"
          - "127.0.0.1"

      config_mode:
        # Configuration mode: "file" or "xds"
        # - file: Load policy chains from static YAML file
        # - xds: Subscribe to xDS server for dynamic configuration updates
        mode: xds

      # xDS client configuration
      xds:
        # Enable xDS client
        enabled: true

        # server_address is set via -xds-server flag (from GATEWAY_CONTROLLER_HOST env var)

        # Node identifier for this policy engine instance
        # Used by xDS server to identify this client
        node_id: policy-engine-1

        # Cluster identifier for this policy engine instance
        # Used for grouping multiple policy engine instances
        cluster: policy-engine-cluster

        # Connection timeout for establishing initial connection
        connect_timeout: 10s

        # Request timeout for individual xDS requests
        request_timeout: 5s

        # Initial delay before reconnecting after connection failure
        initial_reconnect_delay: 1s

        # Maximum delay between reconnection attempts (exponential backoff)
        max_reconnect_delay: 60s

        # TLS configuration for xDS connection
        tls:
          enabled: false
          # cert_path: /path/to/client-cert.pem
          # key_path: /path/to/client-key.pem
          # ca_path: /path/to/ca-cert.pem

      # File-based configuration (not used in xDS mode)
      file_config:
        path: ""

      # Logging configuration
      logging:
        # Log level: debug, info, warn, error
        level: debug

        # Log format: json, text
        format: json

  # Raw TOML string to append to the generated config.toml
  # Use this for additional configuration not covered by the structured values above
  # Example:
  #   config_toml: |
  #     [custom_section]
  #     key = "value"
  config_toml: ""

  # metadata for the generated shared ConfigMap (annotations / labels)
  configMap:
    annotations: {}
    labels: {}

  controller:
    image:
      repository: ghcr.io/wso2/api-platform/gateway-controller
      tag: "0.7.0-SNAPSHOT"
      pullPolicy: Always
    imagePullSecrets: []
    service:
      type: ClusterIP
      annotations: {}
      labels: {}
      ports:
        rest: 9090
        xds: 18000
        policy: 18001
    controlPlane:
      host: host.docker.internal
      port: 8443
      token:
        value: ""
        secretName: ""
        key: token
    # TLS certificate configuration for downstream (listener) HTTPS
    tls:
      # Enable TLS certificate management
      enabled: true
      # Certificate provisioning method: "cert-manager", "secret", or "none"
      # - cert-manager: Use cert-manager to automatically provision certificates
      # - secret: Use an existing Kubernetes secret containing tls.crt and tls.key
      # - none: No TLS configuration (certificates must be provided manually)
      certificateProvider: cert-manager
      # cert-manager configuration (used when certificateProvider=cert-manager)
      certManager:
        # Create a Certificate resource
        create: true
        # Create a self-signed Issuer automatically
        # If true, a self-signed Issuer will be created with the release name
        # If false, you must provide an existing Issuer/ClusterIssuer via issuerRef
        createIssuer: true
        # Issuer reference for cert-manager
        # Note: If createIssuer=true, the 'name' field is ignored and the chart generates a unique name
        # Only set this if createIssuer=false to reference an existing Issuer/ClusterIssuer
        issuerRef:
          name: selfsigned-issuer  # Ignored when createIssuer=true
          # Use "Issuer" for namespace-scoped issuer (recommended)
          # Use "ClusterIssuer" for cluster-wide issuer
          kind: Issuer
          # group: cert-manager.io  # Optional, defaults to cert-manager.io
        # Certificate common name
        commonName: localhost
        # DNS names for the certificate
        dnsNames:
          - localhost
          - "*.localhost"
        # Certificate duration (default: 2160h = 90 days)
        duration: 2160h
        # Certificate renewal time (default: 720h = 30 days before expiry)
        renewBefore: 720h
      # Secret configuration (used when certificateProvider=secret)
      secret:
        # Name of existing secret containing tls.crt and tls.key
        name: gateway-tls
        # Key names in the secret
        certKey: tls.crt
        keyKey: tls.key
    # Upstream certificate configuration for backend TLS verification
    upstreamCerts:
      # Enable custom upstream certificates
      enabled: false
      # Existing secret containing custom CA certificates
      # Secret should contain one or more keys with PEM-encoded certificates
      secretName: ""
      # Existing ConfigMap containing custom CA certificates
      # ConfigMap should contain one or more keys with PEM-encoded certificates
      configMapName: ""
    logging:
      level: info
    storage:
      type: sqlite
      sqlitePath: ./data/gateway.db
    persistence:
      enabled: true
      existingClaim: ""
      accessModes:
        - ReadWriteOnce
      size: 100Mi
      storageClass: ""
    deployment:
      enabled: true
      replicaCount: 1
      volumeMountPath: /app/data
      extraEnv: []
      # extraEnvFrom:
      #   - secretRef:
      #       name: my-secret
      extraEnvFrom: []
      env:
        xdsServerAddress: ""
      extraVolumeMounts: []
      extraVolumes: []
      labels: {}
      annotations: {}
      podAnnotations: {}
      podLabels: {}
      priorityClassName: ""
      livenessProbe:
        httpGet:
          path: /health
          port: rest
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3
      readinessProbe:
        httpGet:
          path: /health
          port: rest
        initialDelaySeconds: 5
        periodSeconds: 5
        timeoutSeconds: 3
        failureThreshold: 3
      # Resource limits and requests
      # Uncomment and adjust based on your workload
      resources: {}
        # limits:
        #   cpu: 500m
        #   memory: 512Mi
        # requests:
        #   cpu: 250m
        #   memory: 256Mi
      podSecurityContext: {}
      securityContext: {}
      nodeSelector: {}
      tolerations: []
      affinity: {}

  # Gateway Runtime - Router (Envoy) and Policy Engine in a single container,
  # communicating via Unix domain socket (UDS)
  gatewayRuntime:
    image:
      repository: ghcr.io/wso2/api-platform/gateway-runtime
      tag: "0.7.0-SNAPSHOT"
      pullPolicy: Always
    imagePullSecrets: []
    service:
      type: ClusterIP
      annotations: {}
      labels: {}
      ports:
        http: 8080
        https: 8443
        envoyAdmin: 9901
        policyEngineAdmin: 9002
        policyEngineMetrics: 9003
    deployment:
      enabled: true
      replicaCount: 1
      env:
        gatewayControllerHost: ""
        logLevel: info
      extraEnv: []
      # extraEnvFrom:
      #   - configMapRef:
      #       name: my-config-map
      extraEnvFrom: []
      extraVolumeMounts: []
      extraVolumes: []
      labels: {}
      annotations: {}
      podAnnotations: {}
      podLabels: {}
      priorityClassName: ""
      livenessProbe:
        httpGet:
          path: /server_info
          port: envoy-admin
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3
      readinessProbe:
        httpGet:
          path: /server_info
          port: envoy-admin
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 3
        failureThreshold: 6
      # Resource limits and requests
      # Uncomment and adjust based on your workload
      resources: {}
        # limits:
        #   cpu: 1000m
        #   memory: 1Gi
        # requests:
        #   cpu: 500m
        #   memory: 512Mi
      podSecurityContext: {}
      securityContext: {}
      nodeSelector: {}
      tolerations: []
      affinity: {}
