{{- $annotations := merge (deepCopy (default (dict) .Values.commonAnnotations)) (default (dict) .Values.gateway.configMap.annotations) -}}
{{- $gc := .Values.gateway.config.gateway_controller -}}
{{- $pe := .Values.gateway.config.policy_engine -}}
{{- $policyEngineHost := printf "%s-policy-engine" (include "gateway-operator.fullname" .) -}}
{{- $controllerHost := printf "%s-controller" (include "gateway-operator.fullname" .) -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway-operator.fullname" . }}-config
  labels:
    {{- include "gateway-operator.labels" . | nindent 4 }}
    {{- with .Values.gateway.configMap.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- if $annotations }}
  annotations:
    {{- toYaml $annotations | nindent 4 }}
  {{- end }}
data:
  config.yaml: |
    gateway_controller:
      server:
        api_port: {{ $gc.server.api_port }}
        xds_port: {{ $gc.server.xds_port }}
        shutdown_timeout: {{ $gc.server.shutdown_timeout }}
      policyserver:
        enabled: {{ $gc.policyserver.enabled }}
        port: {{ $gc.policyserver.port }}
        tls:
          enabled: {{ $gc.policyserver.tls.enabled }}
          cert_file: {{ $gc.policyserver.tls.cert_file | quote }}
          key_file: {{ $gc.policyserver.tls.key_file | quote }}
      storage:
        type: {{ $gc.storage.type }}
        sqlite:
          path: {{ $gc.storage.sqlite.path }}
      policies:
        definitions_path: {{ $gc.policies.definitions_path }}
      router:
        gateway_host: {{ $gc.router.gateway_host | quote }}
        listener_port: {{ $gc.router.listener_port }}
        https_enabled: {{ $gc.router.https_enabled }}
        https_port: {{ $gc.router.https_port }}
        access_logs:
          enabled: {{ $gc.router.access_logs.enabled }}
          format: {{ $gc.router.access_logs.format }}
          json_fields:
            {{- $gc.router.access_logs.json_fields | toYaml | nindent 12 }}
          text_format: |
            {{- $gc.router.access_logs.text_format | nindent 12 }}
        downstream_tls:
          cert_path: {{ $gc.router.downstream_tls.cert_path | quote }}
          key_path: {{ $gc.router.downstream_tls.key_path | quote }}
          minimum_protocol_version: {{ $gc.router.downstream_tls.minimum_protocol_version }}
          maximum_protocol_version: {{ $gc.router.downstream_tls.maximum_protocol_version }}
          ciphers: {{ $gc.router.downstream_tls.ciphers | quote }}
        envoy_upstream:
          tls:
            minimum_protocol_version: {{ $gc.router.envoy_upstream.tls.minimum_protocol_version }}
            maximum_protocol_version: {{ $gc.router.envoy_upstream.tls.maximum_protocol_version }}
            ciphers: {{ $gc.router.envoy_upstream.tls.ciphers | quote }}
            trusted_cert_path: {{ $gc.router.envoy_upstream.tls.trusted_cert_path }}
            custom_certs_path: {{ $gc.router.envoy_upstream.tls.custom_certs_path }}
            verify_host_name: {{ $gc.router.envoy_upstream.tls.verify_host_name }}
            disable_ssl_verification: {{ $gc.router.envoy_upstream.tls.disable_ssl_verification }}
          timeouts:
            route_timeout_in_seconds: {{ $gc.router.envoy_upstream.timeouts.route_timeout_in_seconds }}
            max_route_timeout_in_seconds: {{ $gc.router.envoy_upstream.timeouts.max_route_timeout_in_seconds }}
            route_idle_timeout_in_seconds: {{ $gc.router.envoy_upstream.timeouts.route_idle_timeout_in_seconds }}
        tracing_service_name: {{ $gc.router.tracing_service_name }}
        policy_engine:
          enabled: {{ $gc.router.policy_engine.enabled }}
          host: {{ $policyEngineHost }}
          port: {{ $gc.router.policy_engine.port }}
          timeout_ms: {{ $gc.router.policy_engine.timeout_ms }}
          failure_mode_allow: {{ $gc.router.policy_engine.failure_mode_allow }}
          route_cache_action: {{ $gc.router.policy_engine.route_cache_action }}
          allow_mode_override: {{ $gc.router.policy_engine.allow_mode_override }}
          message_timeout_ms: {{ $gc.router.policy_engine.message_timeout_ms }}
          tls:
            enabled: {{ $gc.router.policy_engine.tls.enabled }}
            cert_path: {{ $gc.router.policy_engine.tls.cert_path | quote }}
            key_path: {{ $gc.router.policy_engine.tls.key_path | quote }}
            ca_path: {{ $gc.router.policy_engine.tls.ca_path | quote }}
            server_name: {{ $gc.router.policy_engine.tls.server_name | quote }}
            skip_verify: {{ $gc.router.policy_engine.tls.skip_verify }}
      {{- if $gc.auth }}
      auth:
        {{- if $gc.auth.basic }}
        basic:
          enabled: {{ $gc.auth.basic.enabled }}
          {{- if $gc.auth.basic.users }}
          users:
            {{- $gc.auth.basic.users | toYaml | nindent 12 }}
          {{- else }}
          users: []
          {{- end }}
        {{- end }}
        {{- if $gc.auth.idp }}
        idp:
          enabled: {{ $gc.auth.idp.enabled }}
          jwks_url: {{ $gc.auth.idp.jwks_url | quote }}
          issuer: {{ $gc.auth.idp.issuer | quote }}
          roles_claim: {{ $gc.auth.idp.roles_claim | quote }}
          {{- if $gc.auth.idp.role_mapping }}
          role_mapping:
            {{- $gc.auth.idp.role_mapping | toYaml | nindent 12 }}
          {{- else }}
          role_mapping: {}
          {{- end }}
        {{- end }}
      {{- end }}
      logging:
        level: {{ $gc.logging.level }}
        format: {{ $gc.logging.format }}
    policy_engine:
      server:
        extproc_port: {{ $pe.server.extproc_port }}
      admin:
        enabled: {{ $pe.admin.enabled }}
        port: {{ $pe.admin.port }}
        allowed_ips:
          {{- $pe.admin.allowed_ips | toYaml | nindent 10 }}
      config_mode:
        mode: {{ $pe.config_mode.mode }}
      xds:
        enabled: {{ $pe.xds.enabled }}
        server_address: {{ $controllerHost }}:{{ .Values.gateway.controller.service.ports.policy }}
        node_id: {{ $pe.xds.node_id }}
        cluster: {{ $pe.xds.cluster }}
        connect_timeout: {{ $pe.xds.connect_timeout }}
        request_timeout: {{ $pe.xds.request_timeout }}
        initial_reconnect_delay: {{ $pe.xds.initial_reconnect_delay }}
        max_reconnect_delay: {{ $pe.xds.max_reconnect_delay }}
        tls:
          enabled: {{ $pe.xds.tls.enabled }}
      file_config:
        path: {{ $pe.file_config.path | quote }}
      logging:
        level: {{ $pe.logging.level }}
        format: {{ $pe.logging.format }}
    {{- if .Values.gateway.config.analytics }}
    analytics:
      enabled: {{ .Values.gateway.config.analytics.enabled }}
      {{- if .Values.gateway.config.analytics.publishers }}
      publishers:
        {{- .Values.gateway.config.analytics.publishers | toYaml | nindent 8 }}
      {{- end }}
      {{- if .Values.gateway.config.analytics.grpc_access_logs }}
      grpc_access_logs:
        host: {{ $policyEngineHost }}
        log_name: {{ .Values.gateway.config.analytics.grpc_access_logs.log_name | quote }}
        buffer_flush_interval: {{ .Values.gateway.config.analytics.grpc_access_logs.buffer_flush_interval }}
        buffer_size_bytes: {{ .Values.gateway.config.analytics.grpc_access_logs.buffer_size_bytes }}
        grpc_request_timeout: {{ .Values.gateway.config.analytics.grpc_access_logs.grpc_request_timeout }}
      {{- end }}
      {{- if .Values.gateway.config.analytics.access_logs_service }}
      access_logs_service:
        als_server_port: {{ .Values.gateway.config.analytics.access_logs_service.als_server_port }}
        shutdown_timeout: {{ .Values.gateway.config.analytics.access_logs_service.shutdown_timeout }}
        public_key_path: {{ .Values.gateway.config.analytics.access_logs_service.public_key_path | quote }}
        private_key_path: {{ .Values.gateway.config.analytics.access_logs_service.private_key_path | quote }}
        als_plain_text: {{ .Values.gateway.config.analytics.access_logs_service.als_plain_text }}
        max_message_size: {{ .Values.gateway.config.analytics.access_logs_service.max_message_size }}
        max_header_limit: {{ .Values.gateway.config.analytics.access_logs_service.max_header_limit }}
      {{- end }}
    {{- end }}
    {{- if .Values.gateway.config.tracing }}
    tracing:
      enabled: {{ .Values.gateway.config.tracing.enabled }}
      endpoint: {{ .Values.gateway.config.tracing.endpoint }}
      insecure: {{ .Values.gateway.config.tracing.insecure }}
      service_version: {{ .Values.gateway.config.tracing.service_version | quote }}
      batch_timeout: {{ .Values.gateway.config.tracing.batch_timeout }}
      max_export_batch_size: {{ .Values.gateway.config.tracing.max_export_batch_size }}
      sampling_rate: {{ .Values.gateway.config.tracing.sampling_rate }}
    {{- end }}
    {{- if .Values.gateway.config.policy_configurations }}
    policy_configurations:
      {{- .Values.gateway.config.policy_configurations | toYaml | nindent 6 }}
    {{- else }}
    policy_configurations: {}
    {{- end }}
