# Gateway Image Build - Testing Guide

## Prerequisites

1. **Docker must be running**
   ```bash
   docker version
   ```
   If Docker is not running, start Docker Desktop or Rancher Desktop.

2. **Build the CLI**
   ```bash
   make build-skip-tests
   ```

## Test Files Created

### 1. test-policy-manifest.yaml
```yaml
version: v1/alpha1
versionResolution: minor
policies:
  - name: basic-auth
    version: v1.0.0
    versionResolution: exact
  - name: jwt-auth
    version: v0.1.0
    versionResolution: exact
```

### 2. policy-manifest-lock.yaml (generated by online mode)
Will be created automatically after running online mode.

## Testing Online Mode

### Basic Online Build
```bash
./build/apipctl gateway image build \
  --image-tag v0.2.0-test \
  -f test-policy-manifest.yaml
```

**Expected Behavior:**
1. ✓ Checks Docker availability
2. ✓ Reads policy-manifest.yaml
3. ✓ Separates local and hub policies
4. ✓ Resolves hub policies from PolicyHub
5. ✓ Downloads/verifies policies (caches to ~/.apipctl/cache/policies/)
6. ✓ Generates policy-manifest-lock.yaml
7. ✓ Displays comprehensive build summary

**Expected Output:**
```
=== Gateway Image Build ===

[1/6] Checking Docker Availability
  ✓ Docker is available

→ Building in ONLINE mode

[2/6] Reading Policy Manifest
  ✓ Loaded manifest with 2 policies

  → Local policies: 0
  → Hub policies: 2

[3/6] Processing Local Policies
  → No local policies to process

[4/6] Resolving Hub Policies from PolicyHub
→ Resolving 2 hub policies...
  → Sending 2 unique policies to PolicyHub
✓ Resolved 2 policies from PolicyHub

→ Downloading and verifying 2 policies...
  basic-auth v1.0.0: downloading... done, verified
  jwt-auth v0.1.0: downloading... done, verified
✓ Downloaded and verified 2 policies

[5/6] Generating Manifest Lock File
  ✓ Generated lock file: policy-manifest-lock.yaml

[6/6] Build Preparation Complete

=== Build Summary ===

Configuration:
  Image Tag:                    v0.2.0-test
  Manifest File:                test-policy-manifest.yaml
  Lock File:                    policy-manifest-lock.yaml
  Image Repository:             ghcr.io/wso2/api-platform
  Gateway Builder:              ghcr.io/wso2/api-platform/gateway-builder:0.2.0
  Gateway Controller Base:      (using builder default)
  Router Base Image:            (using builder default)
  Platform:                     (using host platform)
  Push to Registry:             false
  No Cache:                     false
  Offline Mode:                 false

Policies:
  Total Policies:               2
  Hub Policies:                 2
  Local Policies:               0

Loaded Policies:
  [hub] basic-auth v1.0.0 (checksum: sha256:abc123...)
  [hub] jwt-auth v0.1.0 (checksum: sha256:xyz789...)

✓ All policies loaded and ready for build
```

## Testing Offline Mode

### Prerequisites for Offline Mode
1. Run online mode first to generate lock file and cache policies
2. Ensure policy-manifest-lock.yaml exists

### Basic Offline Build
```bash
./build/apipctl gateway image build \
  --image-tag v0.2.0-test \
  -f test-policy-manifest.yaml \
  --offline
```

**Expected Behavior:**
1. ✓ Checks Docker availability
2. ✓ Reads policy-manifest-lock.yaml
3. ✓ Verifies all hub policies exist in ~/.apipctl/cache/policies/
4. ✓ Verifies all local policies exist in original paths
5. ✓ Verifies checksums for all policies
6. ✓ Displays build summary

**Expected Output:**
```
=== Gateway Image Build ===

[1/6] Checking Docker Availability
  ✓ Docker is available

→ Building in OFFLINE mode

[2/4] Reading Manifest Lock File
  ✓ Loaded lock file with 2 policies

[3/4] Verifying Policies
→ Verifying 2 policies from lock file...
  basic-auth v1.0.0 [hub]: found in cache, checksum verified
  jwt-auth v0.1.0 [hub]: found in cache, checksum verified

✓ Verified 2 policies

[4/4] Build Preparation Complete

=== Build Summary ===

Configuration:
  Image Tag:                    v0.2.0-test
  Manifest Lock File:           policy-manifest-lock.yaml
  Image Repository:             ghcr.io/wso2/api-platform
  Gateway Builder:              ghcr.io/wso2/api-platform/gateway-builder:0.2.0
  Gateway Controller Base:      (using builder default)
  Router Base Image:            (using builder default)
  Platform:                     (using host platform)
  Push to Registry:             false
  No Cache:                     false
  Offline Mode:                 true

Policies:
  Total Policies:               2
  Hub Policies (from cache):    2
  Local Policies:               0

Verified Policies:
  [cache] basic-auth v1.0.0 (checksum: sha256:abc123...)
  [cache] jwt-auth v0.1.0 (checksum: sha256:xyz789...)

✓ All policies verified and ready for build
```

## Error Scenarios

### 1. Offline Mode Without Lock File
```bash
./build/apipctl gateway image build --image-tag v0.2.0 --offline
```
**Expected Error:**
```
Error: policy-manifest-lock.yaml not found at ./policy-manifest-lock.yaml. 
Run without --offline first to generate it.
```

### 2. Offline Mode with Missing Policy in Cache
Delete a policy from cache and run offline mode.
**Expected Error:**
```
Error: policy verification failed: 
  ✗ Policy basic-auth v1.0.0 not found in cache. Run without --offline first.
```

### 3. Offline Mode with Checksum Mismatch
Modify a cached policy and run offline mode.
**Expected Error:**
```
Error: policy verification failed: 
  ✗ Checksum mismatch for basic-auth v1.0.0. Cache may be corrupted. 
Run without --offline to refresh.
```

### 4. Docker Not Running
**Expected Error:**
```
Error: Docker is not available: Docker is not available or not running: exit status 1
```

## Testing with Local Policies

### Create a Local Policy
```bash
mkdir -p my-custom-policy/v1.0.0
echo "# My Custom Policy" > my-custom-policy/v1.0.0/README.md
```

### Update Manifest with Local Policy
```yaml
version: v1/alpha1
versionResolution: minor
policies:
  - name: basic-auth
    version: v1.0.0
    versionResolution: exact
  - name: jwt-auth
    version: v0.1.0
    versionResolution: exact
  - name: MyCustomPolicy
    version: v1.0.0
    filePath: ./my-custom-policy/v1.0.0
```

### Run Online Mode
The command will process the local policy, zip it, and include it in the lock file.

## Cache Location

All policies are cached at:
```
~/.apipctl/cache/policies/
├── basic-auth-v1.0.0.zip
├── jwt-auth-v0.1.0.zip
└── ...
```

## Lock File Format

The generated lock file contains:
```yaml
version: v1/alpha1
policies:
  - name: basic-auth
    version: v1.0.0
    checksum: sha256:abc123def456...
    source: hub
  - name: MyCustomPolicy
    version: v1.0.0
    checksum: sha256:xyz789uvw012...
    source: local
```

## Available Policies in PolicyHub

```
basic-auth/v1.0.0
content-length-guardrail/v0.1.0
json-schema-guardrail/v0.1.0
jwt-auth/v0.1.0
modify-headers/v1.0.0
pii-masking-regex/v0.1.0
regex-guardrail/v0.1.0
respond/v1.0.0
sentence-count-guardrail/v0.1.0
url-guardrail/v0.1.0
word-count-guardrail/v0.1.0
```

## Cleanup

To clean the cache:
```bash
rm -rf ~/.apipctl/cache/
```

To clean test files:
```bash
rm -f test-policy-manifest.yaml policy-manifest-lock.yaml
```
